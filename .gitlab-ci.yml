stages:
  - preparation
  - building
  - testing
  - security
  - deploy

image: edbizarro/gitlab-ci-pipeline-php:7.4-alpine

.init_ssh: &init_ssh |
  eval $(ssh-agent -s)
  echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh
  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

.change_file_permissions: &change_file_permissions |
  find . -type f -not -path "./vendor/*" -exec chmod 664 {} \;
  find . -type d -not -path "./vendor/*" -exec chmod 775 {} \;

# Variables
variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: homestead
  MYSQL_PASSWORD: secret
  MYSQL_DATABASE: homestead
  DB_HOST: mysql

cache:
  key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

composer:
  stage: preparation
  script:
    - php -v
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
    - cp .env.gitlab.testing .env
    - php artisan key:generate
  artifacts:
    paths:
      - vendor/
      - .env
    expire_in: 1 days
    when: always
  cache:
    paths:
      - vendor/

npm:
  stage: preparation
  script:
    - npm --version
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 days
    when: always
  cache:
    paths:
      - node_modules/

build-assets:
  stage: building
  # Download the artifacts for these jobs
  needs:
    - npm
  script:
    - npm --version
    - npm run production --no-progress
  artifacts:
    paths:
      - public/css/
      - public/js/
      - public/fonts/
      - public/mix-manifest.json
    expire_in: 1 days
    when: always

db-seeding:
  stage: building
  services:
    - mysql:5.7
  # Download the artifacts for these jobs
  needs:
    - composer
  script:
    - php artisan migrate:fresh --seed
  artifacts:
    paths:
      - ./storage/logs # for debugging
    expire_in: 1 days
    when: on_failure

phpunit:
  stage: testing
  services:
    - mysql:5.7
  # Download the artifacts for these jobs
  needs:
    - composer
  script:
    - php -v
    - cp .env.gitlab.testing .env
    - vendor/bin/phpunit --coverage-text --colors=never --coverage-clover code-coverage --log-junit test-executions
  artifacts:
    paths:
      - ./storage/logs # for debugging
      - code-coverage
      - test-executions
    expire_in: 1 days
    when: always

codestyle:
  stage: testing
  image: lorisleiva/laravel-docker
  script:
    - phpcs --extensions=php app
  needs: []
  dependencies: []
  allow_failure: true

phpcpd:
  stage: testing
  script:
    - test -f phpcpd.phar || curl -L https://phar.phpunit.de/phpcpd.phar -o phpcpd.phar
    - php phpcpd.phar app/ --min-lines=50
  needs: []
  dependencies: []
  cache:
    paths:
      - phpcpd.phar

sensiolabs:
  stage: security
  script:
    - cd vendor/sensiolabs/security-checker
    - php security-checker security:check ../../../composer.lock
  needs:
    - composer
  cache:
    paths:
      - security-checker/
  allow_failure: true

sonarqube:
  image: johnnei/sonarqube-scanner:3.2.0.1227-4
  stage: security
  needs: []
  dependencies: []
  allow_failure: true
  only:
    - dev
  script:
    - "sonar-scanner -Dsonar.login=$SONAR_TOKEN"


staging:
  stage: deploy
  image: lorisleiva/laravel-docker
  script:
    - *init_ssh
    - *change_file_permissions
    - php artisan deploy 104.248.84.152 -s upload

  environment:
    name: staging
    url: https://bmac.daveroverts.nl

  only:
    - dev

production:
  stage: deploy
  image: lorisleiva/laravel-docker
  script:
    - *init_ssh
    - *change_file_permissions
    - php artisan deploy vps1.dutchvacc.nl -s upload -vvv

  environment:
    name: production
    url: https://booking.dutchvacc.nl

  when: manual

  only:
    - master
